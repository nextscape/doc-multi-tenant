# マルチテナントを考慮すべき非機能要件
Azure をベースとしたシステムを構築する際の非機能要件のうち、マルチテナント特有の要件について説明します。

## ID とアクセス管理
マルチテナント アプリケーションでは、ユーザーを認証認可できるだけでは不十分で、そのユーザーをテナントに関連付ける必要があります。  
一般的には、OIDC 準拠の IdP を使用した認証の結果として返却される JWT トークンに対して、カスタムのクレームを追加することで、ユーザーがどのテナントに属するかを示す情報を提供します。

Microsoft では、Entra ID や Azure AD B2C の使用を推奨しています。独自に IdP を構築することはセキュリティリスクが高く、構築にコストがかかるため、避けるべきアンチパターンとして非推奨とされています。  
しかしながら、Azure AD B2C は、他の Azure リソースと比較して [クォータと制限](https://learn.microsoft.com/ja-jp/azure/active-directory-b2c/service-limits?pivots=b2c-user-flow) が厳しく設定されています。

- テナントあたりの最大要求数（200/秒）
- Azure サブスクリプションあたりのテナントの数（20個）

大規模なマルチテナント アプリケーションの場合、[Azure サブスクリプションの単位でスケーリングする構成](https://learn.microsoft.com/ja-jp/azure/architecture/guide/multitenant/service/azure-ad-b2c) が必要となるため、Auth0 などのサードパーティーの IdP を使用して認証基盤を作り込む選択肢も検討してください。

## モニタリング
マルチテナント アプリケーションに関わらず、Azure をベースとしたシステムを構築する際には、以下のような運用監視が必要です。

| カテゴリ | 監視種類 | 監視内容 |
| --- | --- | --- |
| 異常監視 | 死活監視 | Azure リソースの稼働状態を監視し、システムの障害を早期に検知する。 |
|  | エラー監視 | おもにアプリケーションで発生するエラーを検知する。 |
| 定常監視 | リソース監視 | Azure リソースの CPU、メモリ、ディスクの使用率や容量を監視する。 |
|  | パフォーマンス監視 | アプリケーションの応答時間や処理時間を監視する。 |
| セキュリティ監視 | セキュリティ監視 | サイバー攻撃や不正アクセスなどのセキュリティインシデントを早期に検知する。 |

Azure リソースのメトリクスやログを Log Analytics に集約して、Azure Monitor で可視化することで、システム全体のモニタリングを行うことができます。Azure App Service や Azure Functions については、Application Insights を使用して、アプリケーションのパフォーマンスや利用状況を監視することができます。  
セキュリティインシデントの検知には、Defender for Cloud の導入を検討してください。

マルチテナント アプリケーション固有の考慮事項としては、以下のような項目が挙げられます。
- アプリケーションから出力するログには、テナント ID などのテナントを判別する識別子を含める。
- デプロイ スタンプ追加のタイミングを見極めるため、スタンプごとのリソース使用率や容量を監視する。
- メトリクスには「メータリング」の観点も含め、テナントごとの利用量を監視する。